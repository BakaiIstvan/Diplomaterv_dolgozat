%----------------------------------------------------------------------------
\appendix
%----------------------------------------------------------------------------
\chapter*{\fuggelek}\addcontentsline{toc}{chapter}{\fuggelek}
\setcounter{chapter}{\appendixnumber}
%\setcounter{equation}{0} % a fofejezet-szamlalo az angol ABC 6. betuje (F) lesz
\numberwithin{equation}{section}
\numberwithin{figure}{section}
\numberwithin{lstlisting}{section}
%\numberwithin{tabular}{section}

%----------------------------------------------------------------------------
\section{A 8.3. fejezet minta példájához tartozó Specification osztály}
%----------------------------------------------------------------------------
\begin{lstlisting}[language=java, caption={Specification osztály.},captionpos=b]
import java.io.FileNotFoundException;
import java.io.PrintWriter;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Collections;
import java.util.Comparator;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;

public class Specification{
	private String id = "spec1";
	private ArrayList<Automaton> automatas;
	
	public Specification(){
		automatas = new ArrayList<Automaton>();
		String str;
		String str1;
		String pre;
		String succ;
		State actualState;
		State acceptState;
		State finalState;
		State newState;
		State acceptState_new;
		Automaton a = new Automaton("playlist_generation");
		Automaton b;
		Map<String, Automaton> altauto;
		ArrayList<Automaton> parauto;
		Automaton loopauto;
		Automaton expression;
		int counter = 0;
		
		b = new Automaton("auto7");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
											
		b.addTransition(new Transition("!(" + "user" + "." +	
			"openApp" + "("
			+ ")"
			
			+ "." + "device)", actualState, actualState));
		
		newState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addTransition(new Transition("user" + "." +
		
		"openApp" + "("
		+ ")"
		
		+ "." + "device" , actualState, newState));
		b.addState(newState);
		b.setFinale(newState);
		a.collapse(b);
		
		b = new Automaton("auto7");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
											
		b.addTransition(new Transition("!(" + "device" + "." +	
			"accessWebcam" + "("
			+ ")"
			
			+ "." + "device)", actualState, actualState));
		
		newState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addTransition(new Transition("device" + "." +
		
		"accessWebcam" + "("
		+ ")"
		
		+ "." + "device" , actualState, newState));
		b.addState(newState);
		b.setFinale(newState);
		a.collapse(b);
		
		b = new Automaton("auto3");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
		
		b.addTransition(new Transition("!(" + "device" + "." +
		"getPhoto" + "("
		+ ")"
		
		+ "." + "user" + ")", actualState, actualState));
		
		acceptState = new State("q" + counter, StateType.ACCEPT);
		counter++;
		
		b.addTransition(new Transition("!(" + "device" + "." +
			"getPhoto" + "("
			+ ")"
			
			+ "." + "user" + ")", actualState, acceptState));
		
		b.addState(acceptState);
		
		newState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addTransition(new Transition("device" + "." +
		"getPhoto" + "("
		+ ")"
		+ "." + "user", actualState, newState));
		b.addState(newState);
		b.setFinale(newState);
		a.collapse(b);
		
		b = new Automaton("auto5");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
											
		
		finalState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addState(finalState);
		b.setFinale(finalState);
		
		b.addTransition(new Transition("!(" + "user" + "." +
					"cameraOffline" + "("
					+ ")"
					+ "." + "device)", actualState, finalState));
		
		b.addTransition(new Transition("!(" + "user" + "." +
			"cameraOffline" + "("
			+ ")"
			+ "." + "device)", actualState, actualState));
			
		newState = new State("q" + counter, StateType.ACCEPT);
		counter++;
		b.addTransition(new Transition("user" + "." +
		"cameraOffline" + "("
		+ ")"
		+ "." + "device" , actualState, newState));
		b.addState(newState);
		a.collapse(b);
		
		
		b = new Automaton("auto9");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
											
		finalState = new State("q" + counter, StateType.FINAL);
		counter++;
		acceptState = new State("q" + counter, StateType.ACCEPT);
		counter++;
		b.addTransition(new Transition("device" + "." +
		"retrieveMood" + "("
		+ ")"
		+ "." + "db" , actualState, finalState));
		b.addTransition(new Transition("!(" + "device" + "." +
		"retrieveMood" + "("
		+ ")"
		+ "." + "db" + ")", actualState, acceptState));
		b.addState(acceptState);
		b.addState(finalState);
		b.setFinale(finalState);
		a.collapse(b);
		b = new Automaton("auto3");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
		
		b.addTransition(new Transition("!(" + "device" + "." +
		"retrieveMusic" + "("
		+ ")"
		
		+ "." + "db" + ")", actualState, actualState));
		
		acceptState = new State("q" + counter, StateType.ACCEPT);
		counter++;
		
		b.addTransition(new Transition("!(" + "device" + "." +
			"retrieveMusic" + "("
			+ ")"
			
			+ "." + "db" + ")", actualState, acceptState));
		
		b.addState(acceptState);
		
		newState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addTransition(new Transition("device" + "." +
		"retrieveMusic" + "("
		+ ")"
		+ "." + "db", actualState, newState));
		b.addState(newState);
		b.setFinale(newState);
		a.collapse(b);
		
		
		b = new Automaton("auto12");
		actualState = new State("q" + counter, StateType.NORMAL);
		counter++;
		b.addState(actualState);
		b.setInitial(actualState);
												
		newState = new State("q" + counter, StateType.FINAL);
		counter++;
		b.addTransition(new Transition("db" + "." +
		"generatePlaylist" + "("
		+ ")"
		+ "." + "device", actualState, newState));
		b.addState(newState);
		b.setFinale(newState);
		a.collapse(b);
		a.rename();
		automatas.add(a);
	}
	
	public void listAutomatas(){
		for(Automaton a : this.automatas){
			for(State s : a.getStates()){
				s.writeState();	
			}
			
			for(Transition t : a.getTransitions()){
				t.writeTransition();
			}
		}
	}
	
	public List<Automaton> getAutomata() {
		return automatas;
	}
	
	public ArrayList<Automaton> par(ArrayList<Automaton> automatas) {
	        ArrayList<ArrayList<Automaton>> automataList = new ArrayList<>();
	        permute(automataList, new ArrayList<>(), automatas);
	        return listConverter((automataList));
	}

    private void permute(ArrayList<ArrayList<Automaton>> list, ArrayList<Automaton> resultList, ArrayList<Automaton> automatas) {
        if (resultList.size() == automatas.size()) {
            list.add(new ArrayList<>(resultList));
        } else {
            for (int i = 0; i < automatas.size(); i++) {
                if (resultList.contains((automatas.get(i)))) {
                    continue;
                }

                resultList.add(automatas.get(i));
                permute(list, resultList, automatas);
                resultList.remove(resultList.size() - 1);
            }
        }
    }

    private ArrayList<Automaton> listConverter(ArrayList<ArrayList<Automaton>> list) {
        ArrayList<Automaton> result = new ArrayList<>();
        for (ArrayList<Automaton> alist : list) {
            Automaton newauto = new Automaton("listConverter");
            for (Automaton auto : alist) {
                newauto.collapse(copyAutomaton(auto));
            }
            result.add(newauto);
        }
        return result;
    }
    
    public Map<String, Automaton> loopSetup(Automaton loopauto, int min, int max) {
	        	Map<String, Automaton> result = new HashMap<>();
	    	    
	            for (int i = min; i <= max; i++) {
	                Automaton newauto = new Automaton("loopauto" + i);
	                for (int j = 0; j < i; j++) {
	                    newauto.collapse(copyAutomaton(loopauto));
	                }
	                result.put("loop" + i, newauto);
	            }
	            return result;
	        }
    
    public Automaton copyAutomaton(Automaton referenceAuto) {
            Automaton result = new Automaton("copy automaton");
            int count = 0;
            State previousSender = new State();
            State referencePreviousSender = new State();
    
            for (Transition t : referenceAuto.getTransitions()) {
                State sender = new State();
                State receiver = new State();
                Transition transition = new Transition();
                Automaton temp = new Automaton("temp");
    
                transition.setId(t.getId());
    
                if (t.getSender() == referencePreviousSender) {
                    receiver.setId("c" + count);
                    count++;
                    receiver.setType(t.getReceiver().getType());
    
                    transition.setSender(previousSender);
                    transition.setReceiver(receiver);
                    temp.addState(previousSender);
                    temp.addState(receiver);
                    temp.setInitial(previousSender);
                    temp.setFinale(receiver);
                } else {
                    if (t.getSender() == t.getReceiver()) {
                        sender.setId("c" + count);
                        count++;
                        sender.setType(t.getSender().getType());
    
                        transition.setSender(sender);
                        transition.setReceiver(sender);
    
                        temp.addState(sender);
                        temp.setInitial(sender);
                        temp.setFinale(sender);
                    } else {
                        sender.setId("c" + count);
                        count++;
                        sender.setType(t.getSender().getType());
    
                        receiver.setId("c" + count);
                        count++;
                        receiver.setType(t.getReceiver().getType());
    
                        transition.setSender(sender);
                        transition.setReceiver(receiver);
    
                        temp.addState(sender);
                        temp.addState(receiver);
                        temp.setInitial(sender);
                        temp.setFinale(receiver);
                    }
                    previousSender = sender;
                    referencePreviousSender = t.getSender();
                }
    
                temp.addTransition(transition);
                result.collapse(temp);
            }
    
            return result;
        }
	
	public static void main(String[] args) throws FileNotFoundException, UnsupportedEncodingException{
		Specification specification = new Specification();
		specification.listAutomatas();
		boolean acceptState = false;
}
\end{lstlisting}

%----------------------------------------------------------------------------
\clearpage\section{Monitor forráskód generátor - operátorok támogatása}
%----------------------------------------------------------------------------

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={7.1. scenariohoz tartozó Main osztály.},captionpos=b]
public class Main {
	public static void monitorStatus(String status) {
		System.out.println(status);
	}

	public static void main(String[] args) {
		Specification specification = new Specification();
		specification.listAutomatas();
		IMonitor monitor = new Monitor(specification.getAutomata().get(0));

		UserInterface ui = new UserInterface();
		ATM atm = new ATM();
		BankDB db = new BankDB();
		ui.atm = atm;
		atm.ui = ui;
		atm.db = db;
		ui.monitor = monitor;
		atm.monitor = monitor;
		db.monitor = monitor;

		ui.start();
	}
}
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={7.1. scenariohoz tartozó rendszer ATM Java osztálya.},captionpos=b]
public class ATM {
	public IMonitor monitor;
	public BankDB db;
	public UserInterface ui;

	public void logout() {
		monitor.update("ui", "atm", "logout", new String[] {});
	}

	public void login(boolean success) {
		monitor.update("ui", "atm", "login", new String[] {"success"});
		success = true;
	}

	public void wReq() {
		monitor.update("ui", "atm", "wReq", new String[] {});
		db.uDB();
	}

	public void loginUnsuccessful() {
		monitor.update("ui", "atm", "loginUnsuccesful", new String[] {});
		ui.lockMachine();
	}
}
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={7.1. scenario monitor kimenete.},captionpos=b]
Received Message: ui.login(success).atm
Transition: !(ui.login(success).atm)
Transition: ui.login(success).atm
transition: ui.login(success).atm
q1
System is in bad state.
Received Message: ui.wReq().atm
Transition: epsilon
PrevTransition: epsilon
transition: epsilon
qinit0
System is in bad state.
Transition: epsilon; success == false
PrevTransition: epsilon; success == false
transition: epsilon; success == false
q5
System is in bad state.
Transition: ui.loginUnsuccessful().atm
Transition: !(ui.loginUnsuccessful().atm)
Transition: epsilon; success == true
PrevTransition: epsilon; success == true
transition: epsilon; success == true
q2
System is in bad state.
Transition: ui.wReq().atm
transition: ui.wReq().atm
q3
System is in bad state.
Received Message: atm.uDB().db
Transition: !(atm.uDB().db)
Transition: atm.uDB().db
transition: epsilon
qfinal1
System is in good state.
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Loop operátort tartalmazó scenario.},captionpos=b]
specification spec1{

	object Computer computer;
	object Server server;

	constraint constraints{
		message logout() computer -> server;
	}

	scenario email{
		loop (1, 3) {
			message checkEmail() computer -> computer;
			message newEmail() computer -> server pastConstraint {constraints};
		}
	}
}
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={F.2.4. scenariohoz tartozó monitor kimenet.},captionpos=b]
Received Message: computer.checkEmail().computer
Transition: epsilon; loop2
PrevTransition: epsilon; loop2
transition: epsilon; loop2
q0
System is in bad state.
Transition: computer.checkEmail().computer
Transition: !(computer.checkEmail().computer)
Transition: epsilon; loop3
PrevTransition: epsilon; loop3
transition: epsilon; loop3
q5
System is in bad state.
Transition: computer.checkEmail().computer
Transition: !(computer.checkEmail().computer)
Transition: epsilon; loop1
PrevTransition: epsilon; loop1
transition: epsilon; loop1
q12
System is in bad state.
Transition: computer.checkEmail().computer
transition: computer.checkEmail().computer
q13
System is in bad state.
Received Message: computer.newEmail().server
Transition: !(computer.logout().server) & !(computer.newEmail().server)
Transition: computer.newEmail().server
transition: epsilon
qfinal1
System is in good state.
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={F.2.4. scenariohoz tartozó Main osztály.},captionpos=b]
public class Main {
	public static void monitorStatus(String status) {
		System.out.println(status);
	}

	public static void main(String[] args) {
		Specification specification = new Specification();
		specification.listAutomatas();
		IMonitor monitor = new Monitor(specification.getAutomata().get(0));

		Server server = new Server();
		Computer computer = new Computer(server, monitor);
	}
}
\end{lstlisting}