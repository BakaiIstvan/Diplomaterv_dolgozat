%----------------------------------------------------------------------------
\chapter{A monitor integrálása a Gamma keretrendszerben tervezett komponensekkel}
%----------------------------------------------------------------------------

\section{Gamma keretrendszer}

A \textit{Gamma} keretrendszerrel komponensalapú reaktív rendszereket lehet tervezni, és az a célja hogy támogassa az elosztott rendszerek modelallapú fejlesztését.
A létrehozott rendszert a keretrendszerrel lehet tesztelni, ellenőrizni és szimulálni is.
A keretrendszernek a \textit{Yakindu} modellező eszköz használja, amit kiegészít egy modellező réteggel ahol meg valósítható a komponensek közti kommunikációs hálózat.
A komponensek hierarchikusan helyezkednek el egymás mellett, ami megkönnyíti egyes komponensek többszöri felhasználását.
A tervezett rendszerhez a keretrendszer képes Java forráskódot is generálni.
A modelhez generálhatoak tesztesetek vagy akár verifikálható az UPPAAL model ellenőrző eszköz használatával.

A monitor illesztéséhez a \textit{Gamma} \textit{tutorial} csomagjában lévő rendszert használtam.
Ez egy irányitórendszer modelje, ami egy kereszteződésben lévő közlekedési lámpák működtetésért felel.
A jelző lámpák általános három fokozatú lámpák és a piros-zöld-sárga-piros jelzéseket ismétlik.
A rendszer támogat még egy megszakító állapotot, amit a rendőrség kapcsolhat be.
Ilyenkor minden lámpa sárgán villog.

\clearpage\section{Generált monitor integrációja}

A keretrendszer a \textit{gamma.monitor} csomagba generálja a beépített monitor forráskódja.
Ezt a \textit{Gamma} monitort cseréltem le a saját a monitor komponensemhez tartozó forráskóddal megvalósítva a szükséges interfészeket.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Monitor komponenshez tartozó kódrészlet.},captionpos=b]
public void runComponent() {
    Queue<Event> eventQueue = getProcessQueue();
    while (!eventQueue.isEmpty()) {
            Event event = eventQueue.remove();
            switch (event.getEvent()) {
                case "LightInputs.DisplayNone":
                    update("controller", "light", "displayNone", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayYellow":
                    update("controller", "light", "displayYellow", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayRed":
                    update("controller", "light", "displayRed", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayGreen":
                    update("controller", "light", "displayGreen", new HashMap<String, Object>());
                break;
                default:
                    throw new IllegalArgumentException("No such event!");
            }
    }
    notifyListeners();
}
\end{lstlisting}

A \textit{Gamma} rendszer és a monitor komponens közti kommunikáció megvalósítása a 7.1-es kódrészletben látható.
Ez a rendszer eseményeit továbbítja a generált monitornak a megfelelő alakra alakítva.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Szenárió szöveges leírása.},captionpos=b]
specification Light{

    object TrafficLight light;
    object Controller controller;

    scenario sendEmail{
        message displayRed() controller -> light;
        fail message displayRed() controller -> light;
    }
}
\end{lstlisting}

A 7.2-es kódrészlet tartalmazza a követelmény szcenáriót.
Elvárjuk, hogy ha pirosan világított a lámpa akkor a következő állapotta a lámpának ne legyen megint piros.
Ezt egy \textit{fail} üzenet segítségével tudjuk elérni.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Monitor kimenete.},captionpos=b]
Received Message: controller.displayRed().light
[Monitor] available transition are: 
------------------------------------
controller.displayRed().light, q0->q1, , 
!(controller.displayRed().light), q0->q0, , 
=----------------------------------=
Transition: controller.displayRed().light, q0->q1, , 
transition triggered: controller.displayRed().light, q0->q1, , 
q1
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayGreen().light
[Monitor] available transition are: 
------------------------------------
!(controller.displayRed().light), q1->q3, , 
controller.displayRed().light, q1->q2, , 
!(controller.displayRed().light), q1->q1, , 
=----------------------------------=
Transition: !(controller.displayRed().light), q1->q3, , 
transition triggered: !(controller.displayRed().light), q1->q3, , 
q3
[GammaMonitorTest] Received status from monitor: System is in good state.
[GammaMonitorTest] Received status from monitor: Requirement satisfied
[GammaMonitorTest] Monitor reported that the requirement was satisfied
\end{lstlisting}

A 7.3-as kódrészlet a monitor kimenetét.
A monitor helyes működést érzékelt, a rendszer jó állapotban van és megfelelt a követelménynek.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Szenárió szöveges leírása.},captionpos=b]
specification Light{

    object TrafficLight light;
    object Controller controller;
    object Police police;
    
    bool success = false;
    
    scenario trafficLight {
        message policeInterruptRaised(success) police -> controller;
        
        alt(equals(success, false)) {
            message displayRed() controller -> light;
            message displayGreen() controller -> light;
            message displayYellow() controller -> light;
        } (equals(success, true)) {
            message displayYellow() controller -> light;
        }
        
    }
}
\end{lstlisting}

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Szenárió szöveges leírása.},captionpos=b]
[Automaton] Setting final transition
[Automaton] Setting final transition
[GammaMonitorTest] Resetting values
Received Message: controller.displayRed().light
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: police.policeInterruptRaised(success).controller, q0->q1, ,
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: !(police.policeInterruptRaised(success).controller), q0->q0, ,
transition triggered: !(police.policeInterruptRaised(success).controller), q0->q0, ,
q0
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayRed().light
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: police.policeInterruptRaised(success).controller, q0->q1, ,
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: !(police.policeInterruptRaised(success).controller), q0->q0, ,
transition triggered: !(police.policeInterruptRaised(success).controller), q0->q0, ,
q0
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayGreen().light
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: police.policeInterruptRaised(success).controller, q0->q1, ,
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: !(police.policeInterruptRaised(success).controller), q0->q0, ,
transition triggered: !(police.policeInterruptRaised(success).controller), q0->q0, ,
q0
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: police.policeInterruptRaised(success).controller
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: police.policeInterruptRaised(success).controller, q0->q1, ,
transition triggered: police.policeInterruptRaised(success).controller, q0->q1, ,
q1
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayYellow().light
[Monitor] available transition are:
------------------------------------
epsilon, q1->qinit0
=----------------------------------=
Transition: epsilon, q1->qinit0
[EpsilonTransition]epsilon, q1->qinit0 canTrigger is true
PrevTransition: epsilon, q1->qinit0
[Monitor] available transition are:
------------------------------------
epsilon, qinit0->q2
epsilon, qinit0->q4
=----------------------------------=
Transition: epsilon, qinit0->q2
[EpsilonTransition]epsilon, qinit0->q2 canTrigger is true
PrevTransition: epsilon, qinit0->q2
[Monitor] available transition are:
------------------------------------
!(controller.displayYellow().light), q2->q2, ,
controller.displayYellow().light, q2->q3, ,
epsilon, qinit0->q4
=----------------------------------=
Transition: !(controller.displayYellow().light), q2->q2, ,
[Monitor] available transition are:
------------------------------------
!(controller.displayYellow().light), q2->q2, ,
controller.displayYellow().light, q2->q3, ,
epsilon, qinit0->q4
=----------------------------------=
Transition: controller.displayYellow().light, q2->q3, ,
[Monitor] available transition are:
------------------------------------
!(controller.displayYellow().light), q2->q2, ,
controller.displayYellow().light, q2->q3, ,
epsilon, qinit0->q4
=----------------------------------=
Transition: epsilon, qinit0->q4
[EpsilonTransition]epsilon, qinit0->q4 canTrigger is false
[EpsilonTransition]epsilon, qinit0->q4 canTrigger is false
[Monitor] available transition are:
------------------------------------
!(controller.displayYellow().light), q2->q2, ,
controller.displayYellow().light, q2->q3, ,
=----------------------------------=
Transition: !(controller.displayYellow().light), q2->q2, ,
[Monitor] available transition are:
------------------------------------
!(controller.displayYellow().light), q2->q2, ,
controller.displayYellow().light, q2->q3, ,
=----------------------------------=
Transition: controller.displayYellow().light, q2->q3, ,
transition triggered: controller.displayYellow().light, q2->q3, ,
q3
[GammaMonitorTest] Received status from monitor: System is in good state.
transition triggered: epsilon, q3->qfinal1
qfinal1
[GammaMonitorTest] Received status from monitor: Requirement satisfied
[GammaMonitorTest] Monitor reported that the requirement was satisfied
[Automaton] Setting final transition
[Automaton] Setting final transition
[GammaMonitorTest] Resetting values
Received Message: police.policeInterruptRaised(success).controller
[Monitor] available transition are:
------------------------------------
police.policeInterruptRaised(success).controller, q0->q1, ,
!(police.policeInterruptRaised(success).controller), q0->q0, ,
=----------------------------------=
Transition: police.policeInterruptRaised(success).controller, q0->q1, ,
transition triggered: police.policeInterruptRaised(success).controller, q0->q1, ,
q1
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayRed().light
[Monitor] available transition are:
------------------------------------
epsilon, q1->qinit0
=----------------------------------=
Transition: epsilon, q1->qinit0
[EpsilonTransition]epsilon, q1->qinit0 canTrigger is true
PrevTransition: epsilon, q1->qinit0
[Monitor] available transition are:
------------------------------------
epsilon, qinit0->q2
epsilon, qinit0->q4
=----------------------------------=
Transition: epsilon, qinit0->q2
[EpsilonTransition]epsilon, qinit0->q2 canTrigger is false
[EpsilonTransition]epsilon, qinit0->q2 canTrigger is false
[Monitor] available transition are:
------------------------------------
epsilon, qinit0->q4
=----------------------------------=
Transition: epsilon, qinit0->q4
[EpsilonTransition]epsilon, qinit0->q4 canTrigger is true
PrevTransition: epsilon, qinit0->q4
[Monitor] available transition are:
------------------------------------
controller.displayRed().light, q4->q5, ,
!(controller.displayRed().light), q4->q4, ,
=----------------------------------=
Transition: controller.displayRed().light, q4->q5, ,
transition triggered: controller.displayRed().light, q4->q5, ,
q5
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayRed().light
[Monitor] available transition are:
------------------------------------
controller.displayGreen().light, q5->q6, ,
!(controller.displayGreen().light), q5->q5, ,
=----------------------------------=
Transition: controller.displayGreen().light, q5->q6, ,
[Monitor] available transition are:
------------------------------------
controller.displayGreen().light, q5->q6, ,
!(controller.displayGreen().light), q5->q5, ,
=----------------------------------=
Transition: !(controller.displayGreen().light), q5->q5, ,
transition triggered: !(controller.displayGreen().light), q5->q5, ,
q5
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayGreen().light
[Monitor] available transition are:
------------------------------------
controller.displayGreen().light, q5->q6, ,
!(controller.displayGreen().light), q5->q5, ,
=----------------------------------=
Transition: controller.displayGreen().light, q5->q6, ,
transition triggered: controller.displayGreen().light, q5->q6, ,
q6
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayYellow().light
[Monitor] available transition are:
------------------------------------
controller.displayYellow().light, q6->q7, ,
!(controller.displayYellow().light), q6->q6, ,
=----------------------------------=
Transition: controller.displayYellow().light, q6->q7, ,
transition triggered: controller.displayYellow().light, q6->q7, ,
q7
[GammaMonitorTest] Received status from monitor: System is in good state.
transition triggered: epsilon, q7->qfinal1
qfinal1
[GammaMonitorTest] Received status from monitor: Requirement satisfied
[GammaMonitorTest] Monitor reported that the requirement was satisfied
\end{lstlisting}