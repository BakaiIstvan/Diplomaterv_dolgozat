%----------------------------------------------------------------------------
\chapter{A monitor integrálása a Gamma keretrendszerben tervezett komponensekkel}
%----------------------------------------------------------------------------

\section{Gamma keretrendszer}

A \textit{Gamma} keretrendszerrel komponensalapú reaktív rendszereket lehet tervezni, és az a célja hogy támogassa az elosztott rendszerek modelallapú fejlesztését.
A létrehozott rendszert a keretrendszerrel lehet tesztelni, ellenőrizni és szimulálni is.
A keretrendszernek a \textit{Yakindu} modellező eszköz használja, amit kiegészít egy modellező réteggel ahol meg valósítható a komponensek közti kommunikációs hálózat.
A komponensek hierarchikusan helyezkednek el egymás mellett, ami megkönnyíti egyes komponensek többszöri felhasználását.
A tervezett rendszerhez a keretrendszer képes \textit{Java} forráskódot is generálni.
A modelhez generálhatoak tesztesetek vagy akár verifikálható az \textit{UPPAAL} model ellenőrző eszköz használatával.

A monitor illesztéséhez a \textit{Gamma} \textit{tutorial} csomagjában lévő rendszert használtam.
Ez egy irányitórendszer modelje, ami egy kereszteződésben lévő közlekedési lámpák működtetésért felel.
A jelző lámpák általános három fokozatú lámpák és a piros-zöld-sárga-piros jelzéseket ismétlik.
A rendszer támogat még egy megszakító állapotot, amit a rendőrség kapcsolhat be.
Ilyenkor minden lámpa sárgán villog.

\clearpage\section{Generált monitor integrációja}

A keretrendszer a \textit{gamma.monitor} csomagba generálja a beépített monitor forráskódja.
Ezt a \textit{Gamma} monitort cseréltem le a saját a monitor komponensemhez tartozó forráskóddal megvalósítva a szükséges interfészeket.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Monitor komponenshez tartozó kódrészlet.},captionpos=b,label=gamma_integration_code]
public void runComponent() {
    Queue<Event> eventQueue = getProcessQueue();
    while (!eventQueue.isEmpty()) {
            Event event = eventQueue.remove();
            switch (event.getEvent()) {
                case "LightInputs.DisplayNone":
                    update("controller", "light", "displayNone", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayYellow":
                    update("controller", "light", "displayYellow", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayRed":
                    update("controller", "light", "displayRed", new HashMap<String, Object>());
                break;
                case "LightInputs.DisplayGreen":
                    update("controller", "light", "displayGreen", new HashMap<String, Object>());
                break;
                default:
                    throw new IllegalArgumentException("No such event!");
            }
    }
    notifyListeners();
}
\end{lstlisting}

A \textit{Gamma} rendszer és a monitor komponens közti kommunikáció megvalósítása a \ref{gamma_integration_code}-es kódrészletben látható.
Ez a rendszer eseményeit továbbítja a generált monitornak a megfelelő alakra alakítva.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Szenárió szöveges leírása.},captionpos=b, label=gamma_red_scenario]
specification Light{

    object TrafficLight light;
    object Controller controller;

    scenario sendEmail{
        message displayRed() controller -> light;
        fail message displayRed() controller -> light;
    }
}
\end{lstlisting}

A \ref{gamma_red_scenario}-es kódrészlet tartalmazza a követelmény szcenáriót.
Elvárjuk, hogy ha pirosan világított a lámpa akkor a következő állapotta a lámpának ne legyen megint piros.
Ezt egy \textit{fail} üzenet segítségével tudjuk elérni.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Monitor kimenete.},captionpos=b,label=gamma_red_monitor]
Received Message: controller.displayRed().light
[Monitor] available transition are: 
------------------------------------
controller.displayRed().light, q0->q1, , 
!(controller.displayRed().light), q0->q0, , 
=----------------------------------=
Transition: controller.displayRed().light, q0->q1, , 
transition triggered: controller.displayRed().light, q0->q1, , 
q1
[GammaMonitorTest] Received status from monitor: System is in good state.
Received Message: controller.displayGreen().light
[Monitor] available transition are: 
------------------------------------
!(controller.displayRed().light), q1->q3, , 
controller.displayRed().light, q1->q2, , 
!(controller.displayRed().light), q1->q1, , 
=----------------------------------=
Transition: !(controller.displayRed().light), q1->q3, , 
transition triggered: !(controller.displayRed().light), q1->q3, , 
q3
[GammaMonitorTest] Received status from monitor: System is in good state.
[GammaMonitorTest] Received status from monitor: Requirement satisfied
[GammaMonitorTest] Monitor reported that the requirement was satisfied
\end{lstlisting}

A \ref{gamma_red_monitor}-as kódrészlet a monitor kimenetét.
A monitor helyes működést érzékelt, a rendszer jó állapotban van és megfelelt a követelménynek.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Szenárió szöveges leírása.},captionpos=b,label=gamma_complex_scenario]
specification Light{

    object TrafficLight light;
    object Controller controller;
    object Police police;
    
    bool success = false;
    
    scenario trafficLight {
        message policeInterruptRaised(success) police -> controller;
        
        alt(equals(success, false)) {
            message displayRed() controller -> light;
            message displayGreen() controller -> light;
            message displayYellow() controller -> light;
        } (equals(success, true)) {
            message displayYellow() controller -> light;
            message displayNone() controller -> light;
            message displayYellow() controller -> light;
            message displayNone() controller -> light;
        }
        
    }
}
\end{lstlisting}

A \ref{gamma_complex_scenario}-es kódrészlet egy másik követelményt tartalmaz, amit a rendszeren szeretnénk vizsgálni.
Azt várjuk, hogy ha történt rendőrség általi \textit{interrupt} kérés akkor a lámpa sárgán villogjon.
Ha pedig nem volt ilyen interrupt akkor azt várjuk el, hogy a lámpa rendesen működjön.
A \ref{gamma_police_improvement}-ös kódrészlet tartalmazza az illesztés kiegészítését.
Itt a rendörségi \textit{interrupt} kérést továbbítjuk a monitornak.
A rendszer mindkét esetben a követelménynek megfelelően működött.
A szcenárióhoz tartozó monitor kimenetek a \textit{Függelékben} található meg.

\begin{lstlisting}[language=java, frame=single, float=ht!, caption={Gamma illesztéshez tartozó kódrészlet.},captionpos=b,label=gamma_police_improvement]
@Override
public void raisePolice() {
    monitor.update("police", "controller", "policeInterruptRaised", Map.of("success", true));
    crossroad.getPolice().raisePolice();
}
\end{lstlisting}